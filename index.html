<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Timesheet AI ‚Äî Ipang</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=DM+Mono:wght@400;500&family=Sora:wght@300;400;600;700&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #0d0f14;
    --surface: #141720;
    --surface2: #1c2030;
    --border: #252a3a;
    --accent: #4f8ef7;
    --accent2: #7c6af7;
    --green: #38d9a9;
    --yellow: #ffd43b;
    --red: #ff6b6b;
    --text: #e8eaf0;
    --text2: #8890a8;
    --text3: #4a5068;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: 'Sora', sans-serif;
    min-height: 100vh;
    overflow-x: hidden;
  }

  body::before {
    content: '';
    position: fixed;
    inset: 0;
    background-image:
      linear-gradient(var(--border) 1px, transparent 1px),
      linear-gradient(90deg, var(--border) 1px, transparent 1px);
    background-size: 40px 40px;
    opacity: 0.3;
    pointer-events: none;
  }

  body::after {
    content: '';
    position: fixed;
    top: -200px; left: -200px;
    width: 600px; height: 600px;
    background: radial-gradient(circle, rgba(79,142,247,0.08) 0%, transparent 70%);
    pointer-events: none;
  }

  .glow-orb {
    position: fixed;
    bottom: -200px; right: -100px;
    width: 500px; height: 500px;
    background: radial-gradient(circle, rgba(124,106,247,0.07) 0%, transparent 70%);
    pointer-events: none;
  }

  header {
    padding: 28px 40px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    border-bottom: 1px solid var(--border);
    position: relative;
    z-index: 10;
  }

  .logo {
    display: flex;
    align-items: center;
    gap: 12px;
  }

  .logo-icon {
    width: 36px; height: 36px;
    background: linear-gradient(135deg, var(--accent), var(--accent2));
    border-radius: 10px;
    display: flex; align-items: center; justify-content: center;
    font-size: 16px;
  }

  .logo-text { font-size: 16px; font-weight: 700; letter-spacing: -0.3px; }

  .logo-sub {
    font-size: 11px;
    color: var(--text3);
    font-family: 'DM Mono', monospace;
    letter-spacing: 1px;
    text-transform: uppercase;
  }

  .api-badge {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 8px 16px;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.2s;
    font-size: 12px;
    color: var(--text2);
  }
  .api-badge:hover { border-color: var(--accent); color: var(--text); }

  .api-dot { width: 7px; height: 7px; border-radius: 50%; background: var(--red); }
  .api-dot.connected { background: var(--green); }

  main {
    max-width: 1100px;
    margin: 0 auto;
    padding: 40px 40px 80px;
    position: relative;
    z-index: 10;
  }

  /* ‚îÄ‚îÄ Modal base ‚îÄ‚îÄ */
  .modal-overlay {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.7);
    z-index: 1000;
    align-items: center;
    justify-content: center;
    backdrop-filter: blur(4px);
  }
  .modal-overlay.show { display: flex; }

  .modal {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 16px;
    padding: 32px;
    width: 480px;
    max-width: 90vw;
  }

  .modal h3 { font-size: 18px; margin-bottom: 8px; }
  .modal p { font-size: 13px; color: var(--text2); margin-bottom: 20px; line-height: 1.6; }

  .modal input[type="text"] {
    width: 100%;
    padding: 12px 16px;
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: 8px;
    color: var(--text);
    font-family: 'DM Mono', monospace;
    font-size: 13px;
    margin-bottom: 16px;
    outline: none;
    transition: border-color 0.2s;
  }
  .modal input[type="text"]:focus { border-color: var(--accent); }
  .modal a { color: var(--accent); font-size: 12px; text-decoration: none; }
  .modal a:hover { text-decoration: underline; }

  .btn-row { display: flex; gap: 10px; margin-top: 8px; }

  /* ‚îÄ‚îÄ Settings modal ‚îÄ‚îÄ */
  .settings-modal {
    width: 660px;
    max-width: 95vw;
    max-height: 88vh;
    overflow-y: auto;
    padding: 28px 28px 24px;
  }

  .modal-hdr {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 28px;
  }
  .modal-hdr h3 { margin-bottom: 0; font-size: 16px; }

  .btn-close {
    background: none;
    border: 1px solid var(--border);
    color: var(--text2);
    cursor: pointer;
    font-size: 14px;
    padding: 4px 10px;
    border-radius: 6px;
    transition: all 0.2s;
  }
  .btn-close:hover { border-color: var(--text2); color: var(--text); }

  .settings-section { margin-bottom: 28px; }

  .settings-title {
    font-size: 10px;
    color: var(--text3);
    text-transform: uppercase;
    letter-spacing: 1px;
    font-family: 'DM Mono', monospace;
    margin-bottom: 10px;
    display: flex;
    align-items: center;
    gap: 8px;
  }
  .settings-title::after { content: ''; flex: 1; height: 1px; background: var(--border); }

  .settings-item {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 8px 12px;
    border-radius: 8px;
    background: var(--bg);
    margin-bottom: 5px;
    border: 1px solid var(--border);
    transition: opacity 0.2s;
  }
  .settings-item.inactive { opacity: 0.38; }

  .item-code {
    font-family: 'DM Mono', monospace;
    font-size: 11px;
    color: var(--accent);
    min-width: 86px;
  }
  .item-name { flex: 1; font-size: 12px; color: var(--text2); }

  .toggle-btn {
    width: 32px; height: 18px;
    border-radius: 9px;
    border: none;
    cursor: pointer;
    position: relative;
    transition: background 0.2s;
    flex-shrink: 0;
    background: var(--border);
  }
  .toggle-btn.on { background: var(--green); }
  .toggle-btn::after {
    content: '';
    position: absolute;
    width: 12px; height: 12px;
    border-radius: 50%;
    background: white;
    top: 3px; left: 3px;
    transition: transform 0.2s;
  }
  .toggle-btn.on::after { transform: translateX(14px); }

  .del-btn {
    background: none;
    border: none;
    color: var(--text3);
    cursor: pointer;
    font-size: 14px;
    padding: 2px 6px;
    border-radius: 4px;
    flex-shrink: 0;
    line-height: 1;
  }
  .del-btn:hover { color: var(--red); background: rgba(255,107,107,0.1); }

  .add-form {
    display: none;
    gap: 8px;
    flex-wrap: wrap;
    padding: 12px;
    background: var(--surface2);
    border-radius: 8px;
    margin-top: 8px;
    border: 1px solid var(--border);
  }
  .add-form.show { display: flex; }

  .add-form input, .add-form select {
    padding: 8px 10px;
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: 6px;
    color: var(--text);
    font-family: 'DM Mono', monospace;
    font-size: 12px;
    outline: none;
    transition: border-color 0.2s;
  }
  .add-form input:focus, .add-form select:focus { border-color: var(--accent); }
  .add-form select option { background: var(--surface); }
  .add-form .wide { flex: 1; min-width: 140px; }

  .add-link {
    background: none;
    border: none;
    color: var(--accent);
    font-size: 12px;
    cursor: pointer;
    font-family: 'Sora', sans-serif;
    padding: 6px 0;
    display: block;
    margin-top: 4px;
  }
  .add-link:hover { text-decoration: underline; }

  .settings-note {
    font-size: 12px;
    color: var(--text3);
    margin-bottom: 10px;
    line-height: 1.6;
  }

  .style-textarea {
    width: 100%;
    min-height: 80px;
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: 8px;
    color: var(--text);
    font-family: 'Sora', sans-serif;
    font-size: 13px;
    padding: 12px;
    outline: none;
    resize: vertical;
    line-height: 1.6;
    transition: border-color 0.2s;
  }
  .style-textarea:focus { border-color: var(--accent); }

  /* ‚îÄ‚îÄ Buttons ‚îÄ‚îÄ */
  .btn {
    padding: 10px 20px;
    border-radius: 8px;
    border: none;
    cursor: pointer;
    font-family: 'Sora', sans-serif;
    font-size: 13px;
    font-weight: 600;
    transition: all 0.2s;
    display: inline-flex;
    align-items: center;
    gap: 8px;
  }
  .btn-primary { background: linear-gradient(135deg, var(--accent), var(--accent2)); color: white; }
  .btn-primary:hover { opacity: 0.85; transform: translateY(-1px); }
  .btn-ghost { background: transparent; border: 1px solid var(--border); color: var(--text2); }
  .btn-ghost:hover { border-color: var(--text2); color: var(--text); }
  .btn-sm { padding: 7px 12px; font-size: 12px; }

  /* ‚îÄ‚îÄ Top row ‚îÄ‚îÄ */
  .top-row {
    display: flex;
    gap: 16px;
    margin-bottom: 24px;
    align-items: flex-end;
  }

  .field-group { display: flex; flex-direction: column; gap: 6px; }

  label {
    font-size: 11px;
    color: var(--text3);
    text-transform: uppercase;
    letter-spacing: 1px;
    font-family: 'DM Mono', monospace;
  }

  input[type="date"] {
    padding: 10px 14px;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 8px;
    color: var(--text);
    font-family: 'DM Mono', monospace;
    font-size: 13px;
    outline: none;
    transition: border-color 0.2s;
    color-scheme: dark;
  }
  input[type="date"]:focus { border-color: var(--accent); }

  /* ‚îÄ‚îÄ Input card ‚îÄ‚îÄ */
  .input-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 16px;
    padding: 24px;
    margin-bottom: 24px;
    transition: border-color 0.3s;
  }
  .input-card:focus-within { border-color: rgba(79,142,247,0.4); }

  .input-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 14px;
  }
  .input-title { font-size: 13px; color: var(--text2); font-weight: 600; }
  .char-count { font-family: 'DM Mono', monospace; font-size: 11px; color: var(--text3); }

  textarea {
    width: 100%;
    min-height: 100px;
    background: transparent;
    border: none;
    outline: none;
    color: var(--text);
    font-family: 'Sora', sans-serif;
    font-size: 14px;
    line-height: 1.7;
    resize: none;
  }
  textarea::placeholder { color: var(--text3); }

  .input-footer {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-top: 16px;
    padding-top: 16px;
    border-top: 1px solid var(--border);
  }

  /* ‚îÄ‚îÄ Voice ‚îÄ‚îÄ */
  .voice-btn {
    width: 44px; height: 44px;
    border-radius: 50%;
    background: var(--surface2);
    border: 1px solid var(--border);
    color: var(--text2);
    cursor: pointer;
    display: flex; align-items: center; justify-content: center;
    transition: all 0.2s;
    font-size: 18px;
  }
  .voice-btn:hover { border-color: var(--accent); color: var(--accent); }
  .voice-btn.recording {
    background: rgba(255,107,107,0.15);
    border-color: var(--red);
    color: var(--red);
    animation: pulse-ring 1.5s infinite;
  }
  @keyframes pulse-ring {
    0% { box-shadow: 0 0 0 0 rgba(255,107,107,0.4); }
    70% { box-shadow: 0 0 0 12px rgba(255,107,107,0); }
    100% { box-shadow: 0 0 0 0 rgba(255,107,107,0); }
  }
  .voice-status { font-size: 12px; color: var(--red); font-family: 'DM Mono', monospace; display: none; }
  .voice-status.show { display: block; }

  /* ‚îÄ‚îÄ Generate button ‚îÄ‚îÄ */
  .generate-btn {
    padding: 12px 28px;
    background: linear-gradient(135deg, var(--accent), var(--accent2));
    border: none;
    border-radius: 10px;
    color: white;
    font-family: 'Sora', sans-serif;
    font-weight: 700;
    font-size: 14px;
    cursor: pointer;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    gap: 8px;
  }
  .generate-btn:hover { opacity: 0.88; transform: translateY(-1px); }
  .generate-btn:disabled { opacity: 0.4; cursor: not-allowed; transform: none; }

  /* ‚îÄ‚îÄ Loading ‚îÄ‚îÄ */
  .loading-dots { display: none; gap: 4px; align-items: center; }
  .loading-dots.show { display: flex; }
  .loading-dots span {
    width: 6px; height: 6px;
    border-radius: 50%;
    background: var(--accent);
    animation: bounce 1.2s infinite;
  }
  .loading-dots span:nth-child(2) { animation-delay: 0.2s; }
  .loading-dots span:nth-child(3) { animation-delay: 0.4s; }
  @keyframes bounce {
    0%,60%,100% { transform: translateY(0); }
    30% { transform: translateY(-6px); }
  }

  /* ‚îÄ‚îÄ Result ‚îÄ‚îÄ */
  .result-section { display: none; }
  .result-section.show { display: block; }

  .result-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 16px;
  }
  .result-title { font-size: 14px; font-weight: 700; display: flex; align-items: center; gap: 8px; }

  .entry-count {
    background: rgba(56,217,169,0.15);
    color: var(--green);
    border: 1px solid rgba(56,217,169,0.3);
    padding: 3px 10px;
    border-radius: 20px;
    font-size: 11px;
    font-family: 'DM Mono', monospace;
  }

  .copy-btn {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 10px 20px;
    background: rgba(56,217,169,0.1);
    border: 1px solid rgba(56,217,169,0.3);
    border-radius: 8px;
    color: var(--green);
    cursor: pointer;
    font-family: 'Sora', sans-serif;
    font-size: 13px;
    font-weight: 600;
    transition: all 0.2s;
  }
  .copy-btn:hover { background: rgba(56,217,169,0.2); }
  .copy-btn.copied { color: var(--text2); border-color: var(--border); background: var(--surface); }

  /* ‚îÄ‚îÄ Table ‚îÄ‚îÄ */
  .table-wrap { overflow-x: auto; border: 1px solid var(--border); border-radius: 12px; }

  table { width: 100%; border-collapse: collapse; font-size: 12px; }

  thead th {
    background: var(--surface2);
    padding: 12px 14px;
    text-align: left;
    font-family: 'DM Mono', monospace;
    font-size: 10px;
    color: var(--text3);
    text-transform: uppercase;
    letter-spacing: 0.8px;
    white-space: nowrap;
    border-bottom: 1px solid var(--border);
  }

  tbody tr { border-bottom: 1px solid rgba(37,42,58,0.6); transition: background 0.1s; }
  tbody tr:hover { background: rgba(255,255,255,0.02); }
  tbody tr:last-child { border-bottom: none; }
  tbody td { padding: 11px 14px; color: var(--text2); white-space: nowrap; }

  .td-code { font-family: 'DM Mono', monospace; color: var(--accent); font-size: 11px; }
  .td-time { font-family: 'DM Mono', monospace; color: var(--text); font-size: 11px; }
  .td-mins { font-family: 'DM Mono', monospace; color: var(--yellow); }
  .td-sub { max-width: 300px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; color: var(--text2); font-size: 11px; }
  .td-desc { max-width: 250px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; font-size: 11px; }

  .total-row td { background: var(--surface2) !important; font-weight: 700; color: var(--text) !important; border-top: 1px solid var(--border) !important; }
  .total-row .td-mins { color: var(--yellow) !important; }

  /* ‚îÄ‚îÄ Validation warning ‚îÄ‚îÄ */
  .warn-box {
    display: none;
    margin-top: 14px;
    padding: 12px 16px;
    background: rgba(255,212,59,0.07);
    border: 1px solid rgba(255,212,59,0.3);
    border-radius: 10px;
    color: var(--yellow);
    font-size: 12px;
    line-height: 1.8;
  }
  .warn-box.show { display: block; }

  /* ‚îÄ‚îÄ History ‚îÄ‚îÄ */
  .history-section { margin-top: 40px; display: none; }
  .history-section.show { display: block; }

  .section-label {
    font-size: 11px;
    color: var(--text3);
    text-transform: uppercase;
    letter-spacing: 1px;
    font-family: 'DM Mono', monospace;
    margin-bottom: 14px;
    display: flex;
    align-items: center;
    gap: 8px;
  }
  .section-label::after { content: ''; flex: 1; height: 1px; background: var(--border); }

  .history-list { display: flex; flex-direction: column; gap: 8px; }

  .history-item {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 12px 16px;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 10px;
    cursor: pointer;
    transition: all 0.15s;
  }
  .history-item:hover { border-color: rgba(79,142,247,0.3); }
  .history-date { font-family: 'DM Mono', monospace; font-size: 12px; color: var(--accent); }
  .history-preview { font-size: 12px; color: var(--text2); flex: 1; margin: 0 16px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
  .history-count { font-family: 'DM Mono', monospace; font-size: 11px; color: var(--text3); }

  /* ‚îÄ‚îÄ Toast ‚îÄ‚îÄ */
  .toast {
    position: fixed;
    bottom: 30px; right: 30px;
    padding: 12px 20px;
    background: var(--surface);
    border: 1px solid var(--green);
    border-radius: 10px;
    color: var(--green);
    font-size: 13px;
    font-weight: 600;
    z-index: 9999;
    transform: translateY(20px);
    opacity: 0;
    transition: all 0.3s;
    display: flex;
    align-items: center;
    gap: 8px;
  }
  .toast.show { transform: translateY(0); opacity: 1; }

  /* ‚îÄ‚îÄ Error ‚îÄ‚îÄ */
  .error-box {
    display: none;
    padding: 14px 18px;
    background: rgba(255,107,107,0.08);
    border: 1px solid rgba(255,107,107,0.3);
    border-radius: 10px;
    color: var(--red);
    font-size: 13px;
    margin-bottom: 20px;
  }
  .error-box.show { display: block; }

  /* ‚îÄ‚îÄ Scrollbar ‚îÄ‚îÄ */
  ::-webkit-scrollbar { width: 6px; height: 6px; }
  ::-webkit-scrollbar-track { background: transparent; }
  ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
  ::-webkit-scrollbar-thumb:hover { background: var(--text3); }

  @media (max-width: 640px) {
    header, main { padding-left: 20px; padding-right: 20px; }
    .top-row { flex-direction: column; align-items: stretch; }
    .settings-modal { padding: 20px 16px; }
  }
</style>
</head>
<body>
<div class="glow-orb"></div>

<!-- API Key Modal -->
<div class="modal-overlay" id="apiModal">
  <div class="modal">
    <h3>üîë Gemini API Key</h3>
    <p>Daftarin API key Gemini lo di sini. Tersimpan di browser lo sendiri, gak ke mana-mana.<br><br>
    Belum punya? ‚Üí <a href="https://aistudio.google.com/app/apikey" target="_blank">aistudio.google.com</a> (gratis, pake akun Google)</p>
    <input type="text" id="apiKeyInput" placeholder="AIza..." autocomplete="off">
    <div class="btn-row">
      <button class="btn btn-primary" onclick="saveApiKey()">üíæ Simpan</button>
      <button class="btn btn-ghost" onclick="closeModal()">Batal</button>
    </div>
  </div>
</div>

<!-- Settings / Konteks AI Modal -->
<div class="modal-overlay" id="settingsModal">
  <div class="modal settings-modal">
    <div class="modal-hdr">
      <h3>‚öôÔ∏è Konteks AI</h3>
      <button class="btn-close" onclick="closeSettings()">‚úï Tutup</button>
    </div>

    <!-- Section: Project Codes -->
    <div class="settings-section">
      <div class="settings-title">Project Codes</div>
      <div id="projectList"></div>
      <div id="projectAddForm" class="add-form">
        <input type="text" id="newProjCode" placeholder="EX250099" style="width:100px">
        <input type="text" id="newProjName" placeholder="Nama project..." class="wide">
        <button class="btn btn-primary btn-sm" onclick="addProject()">Tambah</button>
        <button class="btn btn-ghost btn-sm" onclick="toggleAddForm('projectAddForm')">Batal</button>
      </div>
      <button class="add-link" onclick="toggleAddForm('projectAddForm')">+ Tambah project baru</button>
    </div>

    <!-- Section: Jadwal Rutin -->
    <div class="settings-section">
      <div class="settings-title">Jadwal Rutin</div>
      <div id="scheduleList"></div>
      <div id="scheduleAddForm" class="add-form">
        <select id="newSchedDay">
          <option>Senin</option><option>Selasa</option><option>Rabu</option>
          <option>Kamis</option><option>Jumat</option><option>Sabtu</option><option>Minggu</option>
        </select>
        <input type="time" id="newSchedTime" value="09:00" style="width:90px">
        <input type="text" id="newSchedDesc" placeholder="Deskripsi singkat" class="wide">
        <input type="text" id="newSchedCode" placeholder="PR250001" style="width:100px">
        <select id="newSchedSub">
          <option value="">sub-</option>
          <option>A</option><option>B</option><option>C</option><option>D</option>
          <option>E</option><option>F</option><option>G</option><option>H</option><option>X</option>
        </select>
        <button class="btn btn-primary btn-sm" onclick="addSchedule()">Tambah</button>
        <button class="btn btn-ghost btn-sm" onclick="toggleAddForm('scheduleAddForm')">Batal</button>
      </div>
      <button class="add-link" onclick="toggleAddForm('scheduleAddForm')">+ Tambah jadwal rutin</button>
    </div>

    <!-- Section: Model -->
    <div class="settings-section">
      <div class="settings-title">Gemini Model</div>
      <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap">
        <select id="modelSelect" style="padding:9px 12px;background:var(--bg);border:1px solid var(--border);border-radius:8px;color:var(--text);font-family:'DM Mono',monospace;font-size:12px;outline:none;flex:1;min-width:200px">
          <option value="gemini-2.0-flash">gemini-2.0-flash (default)</option>
          <option value="gemini-1.5-flash">gemini-1.5-flash (quota lebih longgar)</option>
          <option value="gemini-2.0-flash-lite">gemini-2.0-flash-lite (paling ringan)</option>
        </select>
        <button class="btn btn-primary btn-sm" onclick="saveModel()">üíæ Simpan</button>
      </div>
      <p class="settings-note" style="margin-top:8px">Kalau sering 429, coba ganti ke gemini-1.5-flash yang punya limit lebih longgar di free tier.</p>
    </div>

    <!-- Section: Gaya Penulisan -->
    <div class="settings-section">
      <div class="settings-title">Gaya Penulisan Description</div>
      <p class="settings-note">Kasih contoh gaya penulisan field description biar AI ngikutin gaya lo. Misal: "Sprint PLTS - analisis suitability desa" atau "Koordinasi internal G-ROCKS terkait update phase 1"</p>
      <textarea class="style-textarea" id="writingStyleInput" placeholder="Tulis beberapa contoh description yang lo mau AI tiru...&#10;Contoh:&#10;- Sprint PLTS - analisis data suitability&#10;- Koordinasi internal G-ROCKS phase 1&#10;- Daily prepare & planning harian"></textarea>
      <div style="margin-top:10px">
        <button class="btn btn-primary btn-sm" onclick="saveWritingStyle()">üíæ Simpan gaya</button>
      </div>
    </div>

  </div>
</div>

<header>
  <div class="logo">
    <div class="logo-icon">‚è±</div>
    <div>
      <div class="logo-text">Timesheet AI</div>
      <div class="logo-sub">Mohamad Irfan Nurmawan</div>
    </div>
  </div>
  <div style="display:flex;gap:8px;align-items:center">
    <div class="api-badge" onclick="openSettings()">‚öôÔ∏è Konteks AI</div>
    <div class="api-badge" onclick="openModal()">
      <div class="api-dot" id="apiDot"></div>
      <span id="apiStatus">Set API Key</span>
    </div>
  </div>
</header>

<main>

  <div class="top-row">
    <div class="field-group">
      <label>Tanggal</label>
      <input type="date" id="dateInput">
    </div>
    <div style="flex:1"></div>
  </div>

  <div class="error-box" id="errorBox"></div>

  <div class="input-card">
    <div class="input-header">
      <span class="input-title">Ceritain hari lo ngapain aja</span>
      <span class="char-count" id="charCount">0 karakter</span>
    </div>
    <textarea
      id="activityInput"
      placeholder="Contoh: Pagi jam 9 ada weekly prepare sejam, terus ngerjain PLTS sampe jam 12. Abis ishoma jam 1 lanjut PLTS lagi sampe jam 3, terus jam 3 ngerjain G-ROCKS sampe jam 5..."
      oninput="updateCharCount()"
    ></textarea>
    <div class="input-footer">
      <div style="display:flex; align-items:center; gap:12px;">
        <button class="voice-btn" id="voiceBtn" onclick="toggleVoice()" title="Voice input">üéô</button>
        <span class="voice-status" id="voiceStatus">‚óè REC</span>
      </div>
      <div style="display:flex; align-items:center; gap:12px;">
        <div class="loading-dots" id="loadingDots">
          <span></span><span></span><span></span>
        </div>
        <button class="generate-btn" id="generateBtn" onclick="generate()">
          ‚ú® Generate Timesheet
        </button>
      </div>
    </div>
  </div>

  <!-- Result -->
  <div class="result-section" id="resultSection">
    <div class="result-header">
      <div class="result-title">
        Hasil
        <span class="entry-count" id="entryCount">0 entries</span>
      </div>
      <button class="copy-btn" id="copyBtn" onclick="copyTable()">
        üìã Copy untuk Excel
      </button>
    </div>
    <div class="table-wrap">
      <table id="resultTable">
        <thead>
          <tr>
            <th>Name</th>
            <th>Date</th>
            <th>Start</th>
            <th>End</th>
            <th>Mins</th>
            <th>Act. Code</th>
            <th>Act. Desc</th>
            <th>Sub Activity</th>
            <th>Description</th>
            <th>Remarks</th>
          </tr>
        </thead>
        <tbody id="resultBody"></tbody>
      </table>
    </div>
    <div class="warn-box" id="warnBox"></div>
  </div>

  <!-- History -->
  <div class="history-section" id="historySection">
    <div class="section-label">Riwayat</div>
    <div class="history-list" id="historyList"></div>
  </div>

</main>

<div class="toast" id="toast"></div>

<script>
const NAME = 'Mohamad Irfan Nurmawan';

const SUB_MAP = {
  F: "F - Project's Ground Work (GIS Analysis, Data Preparation, Minor Design Changes, etc)",
  D: "D - Coordination with relevant stakeholders (internal company) related to product development needs/financial/legal/manpower needs",
  E: "E - Coordination with relevant stakeholders (external company; outsource) related to product development needs/financial/legal/manpower needs",
  C: "C - Project sprint",
  G: "G - Project's Documentation",
  H: "H - Quality Assurance, Bug Search, and Testing",
  A: "A - User research",
  B: "B - PRD",
  X: "X - Project/activity financial report"
};

// ‚îÄ‚îÄ DEFAULT DATA ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

const DEFAULT_PROJECTS = [
  { code: 'EX250029', name: 'PLTS Pertamina (MCDA site suitability)', active: true },
  { code: 'EX250005', name: 'G-ROCKS Geotech (Phase 1 & 2)', active: true },
  { code: 'EX250015', name: 'Geodashboard 2.0 SURGE', active: true },
  { code: 'PR250001', name: 'Daily Meeting & Preparation', active: true },
  { code: 'PR250002', name: 'Weekly Meeting', active: true },
  { code: 'PR250003', name: 'Learning & Development', active: true },
  { code: 'PR250004', name: 'Tech/Design Research', active: true },
  { code: 'AC250005', name: 'Corporate Events', active: true },
  { code: 'AC250009', name: 'Non-productive', active: true },
  { code: 'AC250001', name: "P&C Friday's Activity", active: true },
  { code: 'OP250055', name: 'Pelindo Excube', active: true },
];

const DEFAULT_SCHEDULES = [
  { day: 'Senin',  time: '09:00', desc: 'Weekly prepare',        code: 'PR250001', sub: 'D', active: true },
  { day: 'Selasa', time: '10:00', desc: 'Sprint G-ROCKS',         code: 'EX250005', sub: 'C', active: true },
  { day: 'Kamis',  time: '13:00', desc: 'Weekly G-ROCKS Phase 1', code: 'EX250005', sub: 'D', active: true },
  { day: 'Jumat',  time: '10:00', desc: 'Weekly tim Product',     code: 'PR250001', sub: 'D', active: true },
  { day: 'Jumat',  time: '11:00', desc: 'Jumatan (skip 1 jam)',   code: '',         sub: '',  active: true },
  { day: 'Jumat',  time: '13:30', desc: 'Weekly G-ROCKS Phase 2', code: 'EX250005', sub: 'D', active: true },
];

// ‚îÄ‚îÄ DATA LAYER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

function getProjects() {
  const saved = localStorage.getItem('ts_projects');
  return saved ? JSON.parse(saved) : DEFAULT_PROJECTS;
}
function saveProjects(data) { localStorage.setItem('ts_projects', JSON.stringify(data)); }

function getSchedules() {
  const saved = localStorage.getItem('ts_schedules');
  return saved ? JSON.parse(saved) : DEFAULT_SCHEDULES;
}
function saveSchedules(data) { localStorage.setItem('ts_schedules', JSON.stringify(data)); }

function getWritingStyle() { return localStorage.getItem('ts_style') || ''; }

function buildProjectContext() {
  const projects  = getProjects().filter(p => p.active);
  const schedules = getSchedules().filter(s => s.active);
  const style     = getWritingStyle();

  let ctx = `Daftar Activity Code yang tersedia:\n`;
  projects.forEach(p => { ctx += `- ${p.code}: ${p.name}\n`; });

  ctx += `
Sub Activity codes:
A = User research
B = PRD
C = Project sprint
D = Koordinasi internal (dalam perusahaan)
E = Koordinasi eksternal (klien, outsource)
F = Ground work (GIS analysis, data preparation, pengerjaan teknis project)
G = Documentation
H = Quality Assurance, Bug Search, Testing
X = Financial report

Catatan penting:
- PLTS = EX250029
- Surge/Geodashboard = EX250015
- Lembur = tetap pakai kode project yang dikerjakan
- Jika ke kantor klien (Surge) = EX250015 sub E
- Acara kantor, MC = AC250005
- Activity Description dikosongkan (diisi otomatis di spreadsheet kantor)
`;

  if (schedules.length > 0) {
    ctx += `\nJadwal rutin yang perlu diketahui:\n`;
    schedules.forEach(s => {
      if (s.code) ctx += `- ${s.day} ${s.time}: ${s.desc} ‚Üí ${s.code}/sub ${s.sub}\n`;
      else        ctx += `- ${s.day} ${s.time}: ${s.desc}\n`;
    });
  }

  if (style) {
    ctx += `\nGaya penulisan field "description" yang harus diikuti (tiru pola & tone-nya):\n${style}\n`;
  }

  return ctx;
}

// ‚îÄ‚îÄ API KEY ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

let apiKey = localStorage.getItem('gemini_api_key') || '';
updateApiStatus();

const today = new Date();
document.getElementById('dateInput').value = today.toISOString().split('T')[0];

function updateApiStatus() {
  const dot    = document.getElementById('apiDot');
  const status = document.getElementById('apiStatus');
  if (apiKey) {
    dot.className = 'api-dot connected';
    status.textContent = 'API Connected';
  } else {
    dot.className = 'api-dot';
    status.textContent = 'Set API Key';
    setTimeout(() => openModal(), 500);
  }
}

function openModal() {
  document.getElementById('apiKeyInput').value = apiKey;
  document.getElementById('apiModal').classList.add('show');
}
function closeModal() { document.getElementById('apiModal').classList.remove('show'); }

function saveApiKey() {
  const val = document.getElementById('apiKeyInput').value.trim();
  if (!val) return;
  apiKey = val;
  localStorage.setItem('gemini_api_key', val);
  updateApiStatus();
  closeModal();
  showToast('‚úÖ API key tersimpan!');
}

function updateCharCount() {
  const len = document.getElementById('activityInput').value.length;
  document.getElementById('charCount').textContent = `${len} karakter`;
}

// ‚îÄ‚îÄ VOICE INPUT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

let recognition = null;
let isRecording  = false;

function toggleVoice() {
  if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
    showError('Browser lo tidak support voice input. Coba pakai Chrome.');
    return;
  }
  if (isRecording) { recognition.stop(); return; }

  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
  recognition = new SpeechRecognition();
  recognition.lang = 'id-ID';
  recognition.continuous = true;
  recognition.interimResults = true;

  const textarea = document.getElementById('activityInput');
  const baseText = textarea.value;

  recognition.onstart = () => {
    isRecording = true;
    document.getElementById('voiceBtn').classList.add('recording');
    document.getElementById('voiceBtn').textContent = '‚èπ';
    document.getElementById('voiceStatus').classList.add('show');
  };

  recognition.onresult = (e) => {
    let interim = '', final = '';
    for (let i = e.resultIndex; i < e.results.length; i++) {
      if (e.results[i].isFinal) final += e.results[i][0].transcript;
      else interim += e.results[i][0].transcript;
    }
    textarea.value = baseText + (final || '') + interim;
    updateCharCount();
  };

  recognition.onend = () => {
    isRecording = false;
    document.getElementById('voiceBtn').classList.remove('recording');
    document.getElementById('voiceBtn').textContent = 'üéô';
    document.getElementById('voiceStatus').classList.remove('show');
  };

  recognition.onerror = (e) => {
    showError('Voice error: ' + e.error);
    isRecording = false;
    document.getElementById('voiceBtn').classList.remove('recording');
    document.getElementById('voiceBtn').textContent = 'üéô';
  };

  recognition.start();
}

// ‚îÄ‚îÄ GENERATE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

async function generate() {
  const input   = document.getElementById('activityInput').value.trim();
  const dateVal = document.getElementById('dateInput').value;

  hideError();

  if (!apiKey)   { openModal(); return; }
  if (!input)    { showError('Isi dulu cerita aktivitas lo ya!'); return; }
  if (!dateVal)  { showError('Pilih tanggalnya dulu.'); return; }

  const dateObj       = new Date(dateVal);
  const dateFormatted = dateObj.toLocaleDateString('id-ID', { day:'2-digit', month:'short', year:'2-digit' }).replace(/ /g, '-');

  setLoading(true);

  const prompt = `
Kamu adalah sistem yang mengkonversi deskripsi aktivitas kerja harian menjadi format timesheet yang terstruktur.

${buildProjectContext()}

Format output yang dibutuhkan adalah JSON array, setiap elemen berisi:
- start_hour: "HH:MM" (format 24 jam)
- end_hour: "HH:MM"
- total_minutes: number
- activity_code: string (dari daftar di atas)
- sub_activity: letter only (A/B/C/D/E/F/G/H/X)
- description: string singkat dalam bahasa Indonesia (max 60 karakter)

ATURAN PENTING:
1. Total jam kerja dalam sehari maksimal 7 jam (420 menit), kecuali ada lembur yang eksplisit disebutkan
2. Istirahat 12:00-13:00 tidak dihitung (skip)
3. Kalau ada lembur (malam/sore melewati jam 17:00) tetap masukkan sebagai baris terpisah
4. Jika waktu tidak disebutkan, estimasikan berdasarkan konteks dan isi sisa slot yang wajar
5. Urutan berdasarkan waktu mulai
6. Waktu mulai paling awal 09:00, paling akhir 17:00 (kecuali lembur)

Tanggal hari ini: ${dateFormatted}

Deskripsi aktivitas:
"${input}"

Kembalikan HANYA JSON array valid, tanpa markdown, tanpa penjelasan. Contoh format:
[{"start_hour":"09:00","end_hour":"10:00","total_minutes":60,"activity_code":"PR250001","sub_activity":"D","description":"Weekly prepare - planning harian"}]
`;

  try {
    const model = localStorage.getItem('ts_model') || 'gemini-2.0-flash';
    const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        contents: [{ parts: [{ text: prompt }] }],
        generationConfig: { temperature: 0.2, maxOutputTokens: 2000 }
      })
    });

    if (!res.ok) {
      const err = await res.json();
      const status = res.status;
      if (status === 429) {
        setLoading(false);
        startRateLimitCountdown();
        return;
      }
      throw new Error(err.error?.message || `HTTP ${status}`);
    }

    const data    = await res.json();
    let rawText   = data.candidates?.[0]?.content?.parts?.[0]?.text || '';
    rawText       = rawText.replace(/```json\n?/g, '').replace(/```\n?/g, '').trim();

    let entries;
    try { entries = JSON.parse(rawText); }
    catch(e) { throw new Error('Format response AI tidak valid. Coba lagi.'); }

    saveHistory(dateVal, input, entries);
    renderTable(entries, dateFormatted);
    setLoading(false);
    showToast('‚úÖ Timesheet berhasil digenerate!');

  } catch (err) {
    setLoading(false);
    showError('Error: ' + err.message);
  }
}

let rateLimitTimer = null;
function startRateLimitCountdown() {
  let secs = 60;
  const btn = document.getElementById('generateBtn');
  const dots = document.getElementById('loadingDots');
  dots.classList.remove('show');
  btn.style.display = 'flex';
  btn.disabled = true;

  function tick() {
    btn.textContent = `‚è≥ Rate limit ‚Äî tunggu ${secs}s`;
    if (secs <= 0) {
      btn.textContent = '‚ú® Generate Timesheet';
      btn.disabled = false;
      rateLimitTimer = null;
      showToast('‚úÖ Siap! Coba generate lagi.');
      return;
    }
    secs--;
    rateLimitTimer = setTimeout(tick, 1000);
  }

  showError('Rate limit Gemini (429). Kemungkinan: terlalu banyak request dalam 1 menit, atau daily quota habis. Cek usage di aistudio.google.com');
  tick();
}

// ‚îÄ‚îÄ RENDER TABLE + VALIDASI ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

function renderTable(entries, dateFormatted) {
  const tbody = document.getElementById('resultBody');
  tbody.innerHTML = '';

  let totalMins = 0;

  entries.forEach(entry => {
    const sub     = entry.sub_activity?.toUpperCase();
    const subFull = SUB_MAP[sub] || sub || '';
    const mins    = entry.total_minutes || 0;
    totalMins += mins;

    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${NAME}</td>
      <td class="td-time">${dateFormatted}</td>
      <td class="td-time">${entry.start_hour}</td>
      <td class="td-time">${entry.end_hour}</td>
      <td class="td-mins">${mins}</td>
      <td class="td-code">${entry.activity_code}</td>
      <td></td>
      <td class="td-sub" title="${subFull}">${subFull}</td>
      <td class="td-desc" title="${entry.description}">${entry.description}</td>
      <td></td>
    `;
    tbody.appendChild(tr);
  });

  const totalTr = document.createElement('tr');
  totalTr.className = 'total-row';
  totalTr.innerHTML = `
    <td colspan="4" style="text-align:right; font-family:'DM Mono',monospace; font-size:11px; color:var(--text3);">TOTAL</td>
    <td class="td-mins">${totalMins}</td>
    <td colspan="5"></td>
  `;
  tbody.appendChild(totalTr);

  document.getElementById('entryCount').textContent = `${entries.length} entries ¬∑ ${Math.floor(totalMins/60)}j ${totalMins%60}m`;
  document.getElementById('resultSection').classList.add('show');
  document.getElementById('resultSection').scrollIntoView({ behavior: 'smooth', block: 'start' });

  // Validasi
  showValidation(entries, totalMins);
}

function showValidation(entries, totalMins) {
  const warnings = [];

  // 1. Cek total menit
  if (totalMins < 420) {
    warnings.push(`‚è± Total ${totalMins} menit ‚Äî kurang ${420 - totalMins} menit dari 7 jam kerja (420 menit)`);
  } else if (totalMins > 420) {
    warnings.push(`‚è± Total ${totalMins} menit ‚Äî lebih ${totalMins - 420} menit dari 7 jam. Ada lembur?`);
  }

  // 2. Cek gap antar entry
  const sorted = [...entries].sort((a, b) => a.start_hour.localeCompare(b.start_hour));
  for (let i = 0; i < sorted.length - 1; i++) {
    const end       = sorted[i].end_hour;
    const nextStart = sorted[i + 1].start_hour;
    if (end === nextStart) continue;
    if (end === '12:00' && nextStart === '13:00') continue; // istirahat normal
    warnings.push(`üïê Ada celah waktu kosong: ${end} ‚Üí ${nextStart}`);
  }

  const box = document.getElementById('warnBox');
  if (warnings.length > 0) {
    box.innerHTML = warnings.map(w => `<div>${w}</div>`).join('');
    box.classList.add('show');
  } else {
    box.classList.remove('show');
  }
}

// ‚îÄ‚îÄ COPY ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

function copyTable() {
  const rows = document.getElementById('resultBody').querySelectorAll('tr:not(.total-row)');
  let tsv = '';
  rows.forEach(row => {
    const vals = Array.from(row.querySelectorAll('td')).map(td => td.getAttribute('title') || td.textContent.trim());
    tsv += vals.join('\t') + '\n';
  });

  navigator.clipboard.writeText(tsv).then(() => {
    const btn = document.getElementById('copyBtn');
    btn.textContent = '‚úÖ Copied!';
    btn.classList.add('copied');
    showToast('üìã Data berhasil dicopy! Tinggal Ctrl+V di Excel.');
    setTimeout(() => { btn.innerHTML = 'üìã Copy untuk Excel'; btn.classList.remove('copied'); }, 3000);
  }).catch(() => {
    const ta = document.createElement('textarea');
    ta.value = tsv;
    document.body.appendChild(ta);
    ta.select();
    document.execCommand('copy');
    document.body.removeChild(ta);
    showToast('üìã Data berhasil dicopy!');
  });
}

// ‚îÄ‚îÄ HISTORY ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

function saveHistory(dateVal, input, entries) {
  const history = JSON.parse(localStorage.getItem('ts_history') || '[]');
  history.unshift({ date: dateVal, input: input.substring(0, 100), entries, saved: Date.now() });
  localStorage.setItem('ts_history', JSON.stringify(history.slice(0, 20)));
  renderHistory();
}

function renderHistory() {
  const history = JSON.parse(localStorage.getItem('ts_history') || '[]');
  if (!history.length) return;

  const section = document.getElementById('historySection');
  const list    = document.getElementById('historyList');
  section.classList.add('show');
  list.innerHTML = '';

  history.slice(0, 5).forEach(item => {
    const d     = new Date(item.date);
    const label = d.toLocaleDateString('id-ID', { weekday:'short', day:'2-digit', month:'short', year:'numeric' });
    const div   = document.createElement('div');
    div.className = 'history-item';
    div.innerHTML = `
      <span class="history-date">${label}</span>
      <span class="history-preview">${item.input}...</span>
      <span class="history-count">${item.entries?.length || 0} entries</span>
    `;
    div.onclick = () => {
      document.getElementById('dateInput').value = item.date;
      document.getElementById('activityInput').value = item.input;
      const dateFormatted = d.toLocaleDateString('id-ID', { day:'2-digit', month:'short', year:'2-digit' }).replace(/ /g, '-');
      renderTable(item.entries, dateFormatted);
    };
    list.appendChild(div);
  });
}

// ‚îÄ‚îÄ UTILS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

function setLoading(on) {
  document.getElementById('generateBtn').disabled = on;
  document.getElementById('loadingDots').classList.toggle('show', on);
  document.getElementById('generateBtn').style.display = on ? 'none' : 'flex';
}

function showError(msg) {
  const box = document.getElementById('errorBox');
  box.textContent = '‚ö†Ô∏è ' + msg;
  box.classList.add('show');
}
function hideError() { document.getElementById('errorBox').classList.remove('show'); }

let toastTimer;
function showToast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  clearTimeout(toastTimer);
  toastTimer = setTimeout(() => t.classList.remove('show'), 3000);
}

// ‚îÄ‚îÄ SETTINGS MODAL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

function openSettings() {
  renderProjectList();
  renderScheduleList();
  document.getElementById('writingStyleInput').value = getWritingStyle();
  const savedModel = localStorage.getItem('ts_model') || 'gemini-2.0-flash';
  document.getElementById('modelSelect').value = savedModel;
  document.getElementById('settingsModal').classList.add('show');
}
function closeSettings() { document.getElementById('settingsModal').classList.remove('show'); }

function toggleAddForm(id) {
  const el = document.getElementById(id);
  el.classList.toggle('show');
}

// Projects

function renderProjectList() {
  const projects = getProjects();
  const list     = document.getElementById('projectList');
  list.innerHTML = '';

  projects.forEach((p, i) => {
    const div = document.createElement('div');
    div.className = 'settings-item' + (p.active ? '' : ' inactive');
    div.innerHTML = `
      <span class="item-code">${p.code}</span>
      <span class="item-name">${p.name}</span>
      <button class="toggle-btn ${p.active ? 'on' : ''}" title="${p.active ? 'Nonaktifkan' : 'Aktifkan'}" onclick="toggleProject(${i})"></button>
      <button class="del-btn" title="Hapus" onclick="deleteProject(${i})">‚úï</button>
    `;
    list.appendChild(div);
  });
}

function toggleProject(i) {
  const projects = getProjects();
  projects[i].active = !projects[i].active;
  saveProjects(projects);
  renderProjectList();
}

function deleteProject(i) {
  const projects = getProjects();
  projects.splice(i, 1);
  saveProjects(projects);
  renderProjectList();
}

function addProject() {
  const code = document.getElementById('newProjCode').value.trim().toUpperCase();
  const name = document.getElementById('newProjName').value.trim();
  if (!code || !name) { showToast('‚ö†Ô∏è Isi code dan nama project dulu.'); return; }

  const projects = getProjects();
  projects.push({ code, name, active: true });
  saveProjects(projects);
  document.getElementById('newProjCode').value = '';
  document.getElementById('newProjName').value = '';
  toggleAddForm('projectAddForm');
  renderProjectList();
  showToast(`‚úÖ Project ${code} ditambahkan.`);
}

// Schedules

function renderScheduleList() {
  const schedules = getSchedules();
  const list      = document.getElementById('scheduleList');
  list.innerHTML  = '';

  schedules.forEach((s, i) => {
    const div = document.createElement('div');
    div.className = 'settings-item' + (s.active ? '' : ' inactive');
    const detail = s.code ? `${s.code}/${s.sub}` : '(skip)';
    div.innerHTML = `
      <span class="item-code" style="min-width:52px">${s.day}</span>
      <span class="item-code" style="min-width:44px">${s.time}</span>
      <span class="item-name">${s.desc} <span style="color:var(--text3);font-size:10px">${detail}</span></span>
      <button class="toggle-btn ${s.active ? 'on' : ''}" title="${s.active ? 'Nonaktifkan' : 'Aktifkan'}" onclick="toggleSchedule(${i})"></button>
      <button class="del-btn" title="Hapus" onclick="deleteSchedule(${i})">‚úï</button>
    `;
    list.appendChild(div);
  });
}

function toggleSchedule(i) {
  const schedules  = getSchedules();
  schedules[i].active = !schedules[i].active;
  saveSchedules(schedules);
  renderScheduleList();
}

function deleteSchedule(i) {
  const schedules = getSchedules();
  schedules.splice(i, 1);
  saveSchedules(schedules);
  renderScheduleList();
}

function addSchedule() {
  const day  = document.getElementById('newSchedDay').value;
  const time = document.getElementById('newSchedTime').value;
  const desc = document.getElementById('newSchedDesc').value.trim();
  const code = document.getElementById('newSchedCode').value.trim().toUpperCase();
  const sub  = document.getElementById('newSchedSub').value;
  if (!desc) { showToast('‚ö†Ô∏è Isi deskripsi jadwal dulu.'); return; }

  const schedules = getSchedules();
  schedules.push({ day, time, desc, code, sub, active: true });
  saveSchedules(schedules);
  document.getElementById('newSchedDesc').value = '';
  document.getElementById('newSchedCode').value = '';
  toggleAddForm('scheduleAddForm');
  renderScheduleList();
  showToast(`‚úÖ Jadwal ${day} ${time} ditambahkan.`);
}

// Model

function saveModel() {
  const val = document.getElementById('modelSelect').value;
  localStorage.setItem('ts_model', val);
  showToast(`‚úÖ Model diganti ke ${val}`);
}

// Writing style

function saveWritingStyle() {
  const val = document.getElementById('writingStyleInput').value.trim();
  localStorage.setItem('ts_style', val);
  showToast('‚úÖ Gaya penulisan tersimpan!');
}

// ‚îÄ‚îÄ INIT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

renderHistory();
</script>
</body>
</html>
